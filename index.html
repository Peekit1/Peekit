<!DOCTYPE html>
<html lang="fr" class="scroll-smooth antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <title>Peekit | Studio OS</title>
    <link rel="icon" type="image/svg+xml" href="https://lucide.dev/icons/activity.svg" />

    <script>
      window.onerror = function(msg, url, line, col, error) {
        document.body.innerHTML = `
          <div style="padding:20px; color:red; font-family:monospace; background:#fff0f0; border:2px solid red;">
            <h3>⚠️ L'application a planté</h3>
            <p><strong>Erreur :</strong> ${msg}</p>
            <p><strong>Ligne :</strong> ${line}</p>
            <p>Si vous voyez ceci, copiez ce message pour le diagnostic.</p>
          </div>
        `;
        return false;
      };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Inter"', 'system-ui', 'sans-serif'],
              mono: ['"JetBrains Mono"', 'ui-monospace', 'monospace'],
            },
            backgroundImage: {
              'dot-pattern': "radial-gradient(#E4E4E7 1px, transparent 1px)",
            },
            animation: {
              'fade-in': 'fadeIn 0.4s ease-out forwards',
              'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
            }
          }
        }
      }
    </script>

    <style>
      :root { font-size: 100%; }
      @media (min-width: 1024px) { :root { font-size: 80%; } }
      body { -webkit-font-smoothing: antialiased; background-color: #FFFFFF; }
      .bg-dot-pattern { background-size: 24px 24px; }
    </style>
  </head>
  
  <body class="bg-white text-gray-900 font-sans selection:bg-gray-900 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
      // --- SAFE SETUP ---
      const { useState, useEffect, useRef, useCallback } = React;
      
      // Sécurité pour Supabase
      const createClient = window.supabase ? window.supabase.createClient : () => {
        console.error("Supabase n'est pas chargé");
        return { auth: { getSession: () => Promise.resolve({data:{session:null}}), onAuthStateChange: () => {} } };
      };

      // --- SÉCURITÉ ICÔNES ---
      // Au lieu de déstructurer (qui plante si une icône manque), on crée un objet proxy
      const Icons = window.lucideReact || {};
      
      // Fonction pour récupérer une icône sans planter
      const getIcon = (name) => {
        const Icon = Icons[name];
        if (!Icon) return (props) => <span className="text-xs text-red-500 font-mono" title={`Icône ${name} manquante`}>?</span>;
        return Icon;
      };

      // Récupération des icônes utilisées
      const Activity = getIcon('Activity');
      const Plus = getIcon('Plus');
      const LogOut = getIcon('LogOut');
      const Search = getIcon('Search');
      const LayoutGrid = getIcon('LayoutGrid');
      const Clock = getIcon('Clock');
      const CheckCircle2 = getIcon('CheckCircle2');
      const Package = getIcon('Package');
      const Trash2 = getIcon('Trash2');
      const X = getIcon('X');
      const Pencil = getIcon('Pencil');
      const Menu = getIcon('Menu');
      const ArrowLeft = getIcon('ArrowLeft');
      const ArrowRight = getIcon('ArrowRight');
      const Lock = getIcon('Lock');
      const Loader2 = getIcon('Loader2');
      const Check = getIcon('Check');
      const Zap = getIcon('Zap');
      const Sparkles = getIcon('Sparkles');
      const Building2 = getIcon('Building2');
      const Smartphone = getIcon('Smartphone');
      const ShieldCheck = getIcon('ShieldCheck');
      const Diamond = getIcon('Diamond');
      const Instagram = getIcon('Instagram');
      const Twitter = getIcon('Twitter');
      const Linkedin = getIcon('Linkedin');
      const ExternalLink = getIcon('ExternalLink');

      // --- SUPABASE CONFIG ---
      const supabaseUrl = 'https://ktsyqxkihiexfbksnpyl.supabase.co';
      const supabaseAnonKey = 'sb_publishable_B0fX1XUuLxu0JnpznejCLA_QcdT_a0B';
      const supabase = createClient(supabaseUrl, supabaseAnonKey);

      // --- CONSTANTS ---
      const INITIAL_STAGES_CONFIG = [
        { id: 'secured', label: "Sécurisation", minDays: 0, maxDays: 1, message: "Projet commencé" },
        { id: 'culling', label: "Tri", minDays: 2, maxDays: 5, message: "Création en cours" },
        { id: 'editing', label: "Retouche", minDays: 7, maxDays: 21, message: "Magie en cours" },
        { id: 'export', label: "Export", minDays: 1, maxDays: 2, message: "Préparation" },
        { id: 'delivery', label: "Livraison", minDays: 0, maxDays: 1, message: "Prêt" }
      ];

      // --- COMPOSANTS DE BASE ---

      const Button = ({ children, variant = 'primary', fullWidth = false, isLoading = false, size = 'md', className = '', disabled, ...props }) => {
        const sizeStyles = { sm: 'h-8 px-3 text-xs', md: 'h-10 px-4 text-sm', lg: 'h-12 px-6 text-base' };
        const variants = {
          primary: "bg-gray-900 text-white hover:bg-black",
          black: "bg-gray-900 text-white hover:bg-black",
          secondary: "bg-white text-gray-700 border-gray-200 hover:bg-gray-50",
          outline: "bg-transparent text-gray-700 border-gray-200 hover:bg-gray-50",
          danger: "bg-white text-red-600 border-gray-200 hover:bg-red-50"
        };
        const currentVariant = variants[variant] || variants.primary;
        
        return (
          <button className={`inline-flex items-center justify-center gap-2 font-medium transition-all duration-200 rounded-md border border-transparent ${sizeStyles[size]} ${currentVariant} ${fullWidth ? 'w-full' : ''} ${className}`} disabled={disabled || isLoading} {...props}>
            {isLoading && <Loader2 size={14} className="animate-spin" />} {children}
          </button>
        );
      };

      const Reveal = ({ children, className = "", delay = 0 }) => {
        const [isVisible, setIsVisible] = useState(false);
        const ref = useRef(null);
        useEffect(() => {
          const observer = new IntersectionObserver(([entry]) => { if (entry.isIntersecting) setIsVisible(true); }, { threshold: 0.1 });
          if (ref.current) observer.observe(ref.current);
          return () => observer.disconnect();
        }, []);
        return (
          <div ref={ref} style={{ transitionDelay: `${delay}ms` }} className={`transition-all duration-1000 transform ${isVisible ? "opacity-100 translate-y-0" : "opacity-0 translate-y-12"} ${className}`}>
            {children}
          </div>
        );
      };

      // --- COMPOSANTS UI ---

      const DemoPhone = () => {
        const [activeStep, setActiveStep] = useState(2);
        useEffect(() => { const i = setInterval(() => setActiveStep(p => p < 3 ? p + 1 : 1), 3000); return () => clearInterval(i); }, []);
        const steps = [ { label: "Brief", status: activeStep > 0 ? 'completed' : 'current' }, { label: "Création", status: activeStep > 1 ? 'completed' : activeStep === 1 ? 'current' : 'pending' }, { label: "Livraison", status: activeStep > 2 ? 'completed' : activeStep === 2 ? 'current' : 'pending' }];
        
        return (
          <div className="relative mx-auto bg-gray-900 rounded-[2rem] h-[500px] w-[260px] shadow-2xl overflow-hidden ring-4 ring-gray-900/20">
            <div className="bg-gray-50 w-full h-full pt-8 p-4 flex flex-col font-sans">
               <div className="bg-white rounded-xl p-3 shadow-sm mb-4">
                  <h1 className="text-sm font-bold">Bloom Coffee</h1>
                  <div className="mt-2 h-1 bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-black transition-all duration-700" style={{ width: `${activeStep * 33}%` }}></div></div>
               </div>
               <div className="space-y-3 pl-2 border-l border-gray-200 ml-2">
                 {steps.map((s,i) => (
                   <div key={i} className="flex items-center gap-2">
                     <div className={`w-2 h-2 rounded-full ${s.status === 'completed' ? 'bg-black' : s.status === 'current' ? 'bg-blue-500 animate-pulse' : 'bg-gray-300'}`}></div>
                     <span className="text-xs font-bold text-gray-800">{s.label}</span>
                   </div>
                 ))}
               </div>
            </div>
          </div>
        );
      };

      const Header = ({ onAuth }) => (
        <header className="fixed top-0 w-full z-50 p-4 pointer-events-none">
          <div className="max-w-5xl mx-auto bg-white/90 backdrop-blur-md border border-gray-200 shadow-sm rounded-full px-6 py-3 flex justify-between items-center pointer-events-auto">
             <div className="flex items-center gap-2 font-bold cursor-pointer" onClick={()=>window.scrollTo(0,0)}><Activity size={18}/> Peekit</div>
             <div className="flex gap-4 items-center">
               <button onClick={()=>onAuth('login')} className="text-sm font-medium hover:text-black text-gray-600">Connexion</button>
               <Button size="sm" variant="black" onClick={()=>onAuth('signup')} className="rounded-full">Commencer</Button>
             </div>
          </div>
        </header>
      );

      const Landing = ({ onAuth }) => (
        <div className="pt-32 pb-20 px-6">
           <div className="max-w-4xl mx-auto text-center">
             <Reveal>
               <div className="inline-block px-3 py-1 bg-gray-100 rounded-full text-xs font-bold mb-6">Nouveau : Portail Client v2</div>
               <h1 className="text-5xl md:text-7xl font-bold tracking-tight mb-6">L'expérience client <br/><span className="text-gray-400">qui justifie vos prix.</span></h1>
               <p className="text-xl text-gray-500 mb-8 max-w-2xl mx-auto">Fini les emails de relance. Offrez un lien de suivi premium.</p>
               <Button size="lg" variant="black" onClick={()=>onAuth('signup')} className="rounded-full px-8">Créer mon compte gratuit</Button>
             </Reveal>
             <Reveal delay={200} className="mt-20">
               <DemoPhone />
             </Reveal>
           </div>
        </div>
      );

      // --- AUTH & APP ---

      const AuthPage = ({ onBack, onLogin, initialView }) => {
        const [isLogin, setIsLogin] = useState(initialView === 'login');
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState(null);
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true); setError(null);
            try {
                const { error } = isLogin 
                    ? await supabase.auth.signInWithPassword({ email, password })
                    : await supabase.auth.signUp({ email, password });
                if (error) throw error;
            } catch (err) { setError(err.message); } finally { setLoading(false); }
        };

        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50 p-6">
                <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl">
                    <button onClick={onBack} className="flex items-center gap-2 text-xs font-bold uppercase mb-6"><ArrowLeft size={14}/> Retour</button>
                    <h2 className="text-2xl font-bold mb-6 text-center">{isLogin ? 'Connexion' : 'Inscription'}</h2>
                    {error && <div className="bg-red-50 text-red-600 p-3 rounded text-xs mb-4">{error}</div>}
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <input type="email" required value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full p-3 border rounded-lg"/>
                        <input type="password" required value={password} onChange={e=>setPassword(e.target.value)} placeholder="Mot de passe" className="w-full p-3 border rounded-lg"/>
                        <Button fullWidth variant="black" type="submit" isLoading={loading}>{isLogin ? "Se connecter" : "S'inscrire"}</Button>
                    </form>
                    <button onClick={()=>setIsLogin(!isLogin)} className="w-full text-center text-sm mt-4 text-gray-500 hover:text-black">
                        {isLogin ? "Pas de compte ? Créer" : "Déjà un compte ? Connexion"}
                    </button>
                </div>
            </div>
        );
      };

      const Dashboard = ({ onLogout }) => (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center flex-col p-6">
           <h1 className="text-3xl font-bold mb-4">Bienvenue sur le Dashboard</h1>
           <p className="mb-8">Si vous voyez ceci, tout fonctionne !</p>
           <Button variant="outline" onClick={onLogout}><LogOut size={16}/> Se déconnecter</Button>
        </div>
      );

      // --- RACINE ---

      function App() {
        const [session, setSession] = useState(null);
        const [view, setView] = useState('landing'); // landing, auth, dashboard

        useEffect(() => {
          supabase.auth.getSession().then(({ data: { session } }) => {
            setSession(session);
            if(session) setView('dashboard');
          });
          const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
            setSession(session);
            setView(session ? 'dashboard' : 'landing');
          });
          return () => subscription.unsubscribe();
        }, []);

        const handleAuthNav = (mode) => setView('auth_' + mode);

        if (view.startsWith('auth_')) {
            return <AuthPage initialView={view.split('_')[1]} onBack={()=>setView('landing')} />;
        }
        if (view === 'dashboard' && session) {
            return <Dashboard onLogout={()=>supabase.auth.signOut()} />;
        }

        return (
          <div className="bg-white min-h-screen">
            <Header onAuth={handleAuthNav} />
            <Landing onAuth={handleAuthNav} />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
