<!DOCTYPE html>
<html lang="fr" class="scroll-smooth antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <title>Peekit | Studio OS</title>
    <link rel="icon" type="image/svg+xml" href="https://lucide.dev/icons/activity.svg" />

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Inter"', 'system-ui', 'sans-serif'],
              mono: ['"JetBrains Mono"', 'ui-monospace', 'monospace'],
            },
            colors: {
              gray: { 50: '#FAFAFA', 100: '#F4F4F5', 200: '#E4E4E7', 300: '#D4D4D8', 400: '#A1A1AA', 500: '#71717A', 600: '#52525B', 700: '#3F3F46', 800: '#27272A', 900: '#18181B', 950: '#09090B' },
            },
            backgroundImage: {
              'dot-pattern': "radial-gradient(#E4E4E7 1px, transparent 1px)",
            },
            animation: {
              'fade-in': 'fadeIn 0.4s ease-out forwards',
              'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
            }
          }
        }
      }
    </script>
    <style>
      :root { font-size: 100%; }
      @media (min-width: 1024px) { :root { font-size: 80%; } }
      body { -webkit-font-smoothing: antialiased; background-color: #FFFFFF; }
      .bg-dot-pattern { background-size: 24px 24px; }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #E4E4E7; border-radius: 3px; }
    </style>
  </head>
  
  <body class="bg-white text-gray-900 font-sans selection:bg-gray-900 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
      // --- SAFE SETUP (ANTI-CRASH) ---
      const { useState, useEffect, useRef, useCallback } = React;

      // 1. Supabase Safe Client
      const supabaseUrl = 'https://ktsyqxkihiexfbksnpyl.supabase.co';
      const supabaseAnonKey = 'sb_publishable_B0fX1XUuLxu0JnpznejCLA_QcdT_a0B';
      const createClient = window.supabase ? window.supabase.createClient : () => ({ auth: { getSession:()=>Promise.resolve({data:{}}), onAuthStateChange:()=>{} }, from:()=>({select:()=>({eq:()=>({single:()=>({data:null})})})}) });
      const supabase = createClient(supabaseUrl, supabaseAnonKey);

      // 2. Lucide Icons Safe Proxy (Empêche l'écran blanc si une icône manque)
      const Icons = window.lucideReact || {};
      const getIcon = (name) => {
          const Icon = Icons[name];
          if (!Icon) return (props) => <span style={{color:'red', fontSize:'10px'}}>?</span>;
          return Icon;
      };

      // MAPPING COMPLET DES ICONES UTILISÉES
      const Plus = getIcon('Plus');
      const LogOut = getIcon('LogOut');
      const Search = getIcon('Search');
      const LayoutGrid = getIcon('LayoutGrid');
      const Activity = getIcon('Activity');
      const Clock = getIcon('Clock');
      const CheckCircle2 = getIcon('CheckCircle2');
      const Package = getIcon('Package');
      const Trash2 = getIcon('Trash2');
      const X = getIcon('X');
      const Pencil = getIcon('Pencil');
      const MoreVertical = getIcon('MoreVertical');
      const Calendar = getIcon('Calendar');
      const MapPin = getIcon('MapPin');
      const ChevronRight = getIcon('ChevronRight');
      const Command = getIcon('Command');
      const BarChart3 = getIcon('BarChart3');
      const Users = getIcon('Users');
      const Wallet = getIcon('Wallet');
      const Bell = getIcon('Bell');
      const ArrowRight = getIcon('ArrowRight');
      const CreditCard = getIcon('CreditCard');
      const Sparkles = getIcon('Sparkles');
      const Building2 = getIcon('Building2');
      const Zap = getIcon('Zap');
      const Check = getIcon('Check');
      const Camera = getIcon('Camera');
      const Video = getIcon('Video');
      const Aperture = getIcon('Aperture');
      const Heart = getIcon('Heart');
      const Menu = getIcon('Menu');
      const ArrowLeft = getIcon('ArrowLeft');
      const Mail = getIcon('Mail');
      const Lock = getIcon('Lock');
      const Loader2 = getIcon('Loader2');
      const AlertCircle = getIcon('AlertCircle');
      const ShieldCheck = getIcon('ShieldCheck');
      const ArrowDownToLine = getIcon('ArrowDownToLine');
      const LinkIcon = getIcon('Link');
      const Upload = getIcon('Upload');
      const ExternalLink = getIcon('ExternalLink');
      const RefreshCcw = getIcon('RefreshCcw');
      const User = getIcon('User');
      const Diamond = getIcon('Diamond');
      const Smartphone = getIcon('Smartphone');
      const Instagram = getIcon('Instagram');
      const Twitter = getIcon('Twitter');
      const Linkedin = getIcon('Linkedin');
      const FileImage = getIcon('FileImage');
      const Film = getIcon('Film');
      const Settings = getIcon('Settings');
      const FolderOpen = getIcon('FolderOpen');
      const MessageSquare = getIcon('MessageSquare');

      // --- CONSTANTS ---
      const INITIAL_STAGES_CONFIG = [
        { id: 'secured', label: "Sécurisation des fichiers", minDays: 0, maxDays: 1, message: "Projet commencé" },
        { id: 'culling', label: "Tri", minDays: 2, maxDays: 5, message: "Création en cours" },
        { id: 'editing', label: "Retouche", minDays: 7, maxDays: 21, message: "C'est Ici que la magie opère" },
        { id: 'export', label: "Export", minDays: 1, maxDays: 2, message: "Préparation des livrables" },
        { id: 'delivery', label: "Livraison", minDays: 0, maxDays: 1, message: "Fichiers prêts à être envoyés" }
      ];

      // --- UI COMPONENTS ---

      const Button = ({ children, variant = 'primary', fullWidth = false, isLoading = false, size = 'md', className = '', disabled, ...props }) => {
        const sizeStyles = { sm: 'h-8 px-3 text-xs', md: 'h-10 px-4 text-sm', lg: 'h-12 px-6 text-base' };
        const baseStyles = `inline-flex items-center justify-center gap-2 font-medium transition-all duration-200 rounded-md border active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-900`;
        const variants = {
          primary: "bg-gray-900 text-white border-transparent hover:bg-black",
          black: "bg-gray-900 text-white border-transparent hover:bg-black",
          secondary: "bg-white text-gray-700 border-gray-200 hover:border-gray-300 hover:bg-gray-50",
          outline: "bg-transparent text-gray-700 border-gray-200 hover:border-gray-300 hover:bg-gray-50",
          ghost: "bg-transparent border-transparent text-gray-500 hover:text-gray-900 hover:bg-gray-100",
          danger: "bg-white text-red-600 border-gray-200 hover:bg-red-50 hover:border-red-200"
        };
        return (
          <button className={`${baseStyles} ${sizeStyles[size]} ${variants[variant]} ${fullWidth ? 'w-full' : ''} ${className}`} disabled={disabled || isLoading} {...props}>
            {isLoading && <Loader2 size={14} className="animate-spin" />} {children}
          </button>
        );
      };

      const Reveal = ({ children, className = "", delay = 0, width = "100%" }) => {
        const [isVisible, setIsVisible] = useState(false);
        const ref = useRef(null);
        useEffect(() => {
          const observer = new IntersectionObserver(([entry]) => { if (entry.isIntersecting) { setIsVisible(true); observer.disconnect(); } }, { threshold: 0.1 });
          if (ref.current) observer.observe(ref.current);
          return () => observer.disconnect();
        }, []);
        return (
          <div ref={ref} style={{ width, transitionDelay: `${delay}ms` }} className={`transition-all duration-1000 cubic-bezier(0.17, 0.55, 0.55, 1) transform ${isVisible ? "opacity-100 translate-y-0 filter-none" : "opacity-0 translate-y-12 blur-sm"} ${className}`}>
            {children}
          </div>
        );
      };

      // --- SECTION COMPONENTS ---

      const DemoPhone = () => {
        const [activeStep, setActiveStep] = useState(2);
        useEffect(() => { const i = setInterval(() => setActiveStep(p => p < 3 ? p + 1 : 1), 3000); return () => clearInterval(i); }, []);
        const steps = [ { label: "Brief / Sécurisation", status: activeStep > 0 ? 'completed' : 'current' }, { label: "Recherches / Moodboard", status: activeStep > 1 ? 'completed' : activeStep === 1 ? 'current' : 'pending' }, { label: "Création / Design", status: activeStep > 2 ? 'completed' : activeStep === 2 ? 'current' : 'pending' }, { label: "Livraison", status: 'pending' }];
        return (
          <div className="relative mx-auto bg-gray-900 rounded-[2.5rem] sm:rounded-[3rem] h-[500px] w-[260px] sm:h-[640px] sm:w-[320px] shadow-2xl flex flex-col overflow-hidden ring-4 sm:ring-8 ring-gray-900/20 transition-all duration-300">
            <div className="bg-gray-50 w-full h-full pt-8 sm:pt-10 pb-6 overflow-hidden flex flex-col font-sans rounded-[2rem] sm:rounded-[2.5rem]">
              <div className="absolute top-0 inset-x-0 h-6 sm:h-7 bg-gray-900 z-20 w-28 sm:w-36 mx-auto rounded-b-xl sm:rounded-b-2xl"></div>
              <div className="bg-white border-b border-gray-200 h-10 sm:h-12 flex items-center justify-between px-4 sm:px-5 shrink-0 z-10">
                  <div className="flex items-center gap-2"><Activity size={10} className="text-black"/><span className="font-bold text-xs tracking-tight text-gray-900">Peekit</span></div>
                  <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
              </div>
              <div className="flex-1 overflow-hidden p-3 sm:p-4 space-y-3">
                  <div className="bg-white border border-gray-200 rounded-xl p-3 shadow-[0_2px_8px_rgba(0,0,0,0.02)]">
                      <div className="flex items-center gap-2"><span className="bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider flex items-center gap-1"><Package size={8}/> Branding</span></div>
                      <h1 className="text-lg font-bold text-gray-900 tracking-tight mb-2">Bloom Coffee</h1>
                      <div className="mt-2 h-1.5 w-full bg-gray-100 rounded-full overflow-hidden"><div className="h-full bg-gray-900 rounded-full transition-all duration-700 ease-out" style={{ width: `${activeStep * 25}%` }}></div></div>
                  </div>
                  <div className="bg-white border border-gray-200 rounded-xl p-3 shadow-sm">
                      <h3 className="font-bold text-gray-900 text-[10px] uppercase tracking-widest mb-3">Historique</h3>
                      <div className="space-y-2 relative pl-1">
                          <div className="absolute left-[11px] top-2 bottom-2 w-px bg-gray-100 -z-0"></div>
                          {steps.map((step, idx) => (
                              <div key={idx} className="flex items-center gap-3 relative z-10">
                                  <div className={`w-6 h-6 rounded-lg flex items-center justify-center border ${step.status === 'completed' ? 'bg-gray-900 text-white border-gray-900' : step.status === 'current' ? 'bg-white border-indigo-600 text-indigo-600' : 'bg-white border-gray-100'}`}>{step.status === 'completed' ? <CheckCircle2 size={10}/> : <div className={`w-1.5 h-1.5 rounded-full ${step.status === 'current' ? 'bg-indigo-600' : 'bg-gray-200'}`}/>}</div>
                                  <span className="text-[10px] font-bold text-gray-900">{step.label}</span>
                              </div>
                          ))}
                      </div>
                  </div>
              </div>
            </div>
          </div>
        );
      };

      const StickyHeader = ({ onAuthClick }) => {
        const [isScrolled, setIsScrolled] = useState(false);
        const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
        useEffect(() => { const h = () => setIsScrolled(window.scrollY > 30); window.addEventListener('scroll', h); return () => window.removeEventListener('scroll', h); }, []);
        const scrollTo = (id) => { setIsMobileMenuOpen(false); document.getElementById(id)?.scrollIntoView({ behavior: 'smooth' }); };

        return (
          <>
            <div className="fixed top-0 left-0 right-0 z-50 flex justify-center pointer-events-none p-4 md:p-6">
                <header className={`pointer-events-auto transition-all duration-700 cubic-bezier(0.16, 1, 0.3, 1) flex items-center justify-between px-4 ${isScrolled ? 'w-full max-w-2xl bg-white/80 backdrop-blur-xl border border-gray-200 shadow-xl rounded-full py-2' : 'w-full max-w-6xl bg-transparent border-transparent py-4'}`}>
                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}>
                        <div className="w-8 h-8 bg-gray-900 rounded-full flex items-center justify-center text-white"><Activity size={16} strokeWidth={2.5}/></div>
                        <span className={`font-bold text-sm text-gray-900 hidden sm:block ${isScrolled ? 'hidden' : ''}`}>Peekit</span>
                    </div>
                    <div className="flex items-center gap-1">
                        <div className="hidden md:flex items-center mr-2">
                            <button onClick={() => scrollTo('concept')} className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-900">Concept</button>
                            <button onClick={() => scrollTo('pricing')} className="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-900">Tarifs</button>
                        </div>
                        <div className="hidden md:block w-px h-4 bg-gray-200 mx-2"></div>
                        <button className="hidden md:block text-sm font-medium text-gray-600 hover:text-gray-900 px-4 py-2" onClick={() => onAuthClick('login')}>Connexion</button>
                        <Button variant="black" size="sm" onClick={() => onAuthClick('signup')} className="!rounded-full !px-5">Commencer</Button>
                        <button className="md:hidden p-2 ml-1" onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>{isMobileMenuOpen ? <X size={20}/> : <Menu size={20}/>}</button>
                    </div>
                </header>
            </div>
            {isMobileMenuOpen && (
                <div className="fixed inset-0 z-40 bg-white pt-32 px-6 md:hidden animate-fade-in">
                    <nav className="flex flex-col gap-6 text-center">
                        <button onClick={() => scrollTo('concept')} className="text-xl font-medium text-gray-900">Concept</button>
                        <button onClick={() => scrollTo('pricing')} className="text-xl font-medium text-gray-900">Tarifs</button>
                        <div className="w-full h-px bg-gray-100 my-4"></div>
                        <button onClick={() => onAuthClick('login')} className="text-lg text-gray-500">Connexion</button>
                    </nav>
                </div>
            )}
          </>
        );
      };

      const Hero = ({ onAuthClick }) => (
        <section className="relative pt-32 pb-16 md:pt-40 md:pb-32 overflow-hidden bg-white border-b border-gray-100">
            <div className="absolute inset-0 bg-[linear-gradient(to_right,#80808012_1px,transparent_1px),linear-gradient(to_bottom,#80808012_1px,transparent_1px)] bg-[size:24px_24px]"></div>
            <div className="container mx-auto px-4 md:px-6 max-w-7xl relative z-10">
                <div className="grid lg:grid-cols-2 gap-12 items-center">
                    <div className="text-center lg:text-left">
                        <Reveal>
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-50 border border-gray-200 text-[10px] font-bold text-gray-900 mb-6 cursor-default">
                                <span className="relative flex h-2 w-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span> Nouveau : Portail Client v2.0
                            </div>
                        </Reveal>
                        <Reveal delay={100}>
                            <h1 className="text-4xl sm:text-6xl lg:text-7xl font-bold text-gray-900 tracking-tighter mb-6 leading-[1.05]">L'expérience client qui <span className="text-gray-400">justifie vos tarifs.</span></h1>
                        </Reveal>
                        <Reveal delay={200}>
                            <p className="text-lg text-gray-500 mb-8 max-w-lg mx-auto lg:mx-0">Fini les emails de relance. Offrez à vos clients un lien de suivi premium. Le standard des grandes agences, enfin accessible.</p>
                        </Reveal>
                        <Reveal delay={300}>
                            <Button variant="black" size="lg" onClick={() => onAuthClick('signup')} className="rounded-full px-8 h-14 shadow-xl">Commencer maintenant <ArrowRight size={16}/></Button>
                        </Reveal>
                    </div>
                    <div className="relative flex justify-center lg:justify-end mt-8 lg:mt-0">
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] bg-gradient-to-tr from-gray-100/50 via-white to-indigo-50/30 rounded-full blur-3xl -z-10"></div>
                        <div className="relative w-full max-w-lg bg-white rounded-xl border border-gray-200 shadow-2xl overflow-hidden z-10 animate-slide-up scale-90 sm:scale-100">
                            <div className="h-8 bg-white border-b border-gray-100 flex items-center px-3 gap-1.5"><div className="w-2.5 h-2.5 rounded-full bg-gray-200"></div><div className="w-2.5 h-2.5 rounded-full bg-gray-200"></div><div className="w-2.5 h-2.5 rounded-full bg-gray-200"></div></div>
                            <div className="p-6">
                                <div className="flex justify-between items-center mb-6"><div><div className="text-lg font-bold text-gray-900">Projets Actifs</div><div className="text-xs text-gray-400">Vue d'ensemble</div></div><div className="w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center text-xs font-bold">SL</div></div>
                                <div className="space-y-3">
                                    <div className="p-3 rounded-lg border border-gray-100 bg-white flex items-center justify-between shadow-sm"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded bg-gray-100"></div><div><div className="text-sm font-bold text-gray-900">Nike Campaign</div><div className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-1.5 rounded w-fit">Vidéo</div></div></div><div className="text-right"><div className="text-xs font-bold">65%</div><div className="text-[10px] text-gray-400">En cours</div></div></div>
                                    <div className="p-3 rounded-lg border border-gray-100 bg-white flex items-center justify-between shadow-sm opacity-60"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded bg-gray-100"></div><div><div className="text-sm font-bold text-gray-900">Mariage Julia</div><div className="text-[10px] font-bold text-rose-600 bg-rose-50 px-1.5 rounded w-fit">Photo</div></div></div><div className="text-right"><div className="text-xs font-bold">100%</div><div className="text-[10px] text-emerald-600">Livré</div></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
      );

      const Problem = () => (
        <section className="py-24 bg-white border-b border-gray-100">
          <div className="container mx-auto px-6 max-w-5xl grid md:grid-cols-2 gap-16 items-center">
            <Reveal><div className="bg-gray-50 rounded-2xl p-8 border border-gray-100 space-y-4"><div className="bg-white p-4 rounded-xl shadow-sm max-w-[85%]"><p className="text-sm text-gray-600">"Hello ! On voulait savoir où en est le montage ?"</p></div><div className="bg-blue-50 p-4 rounded-xl ml-auto max-w-[85%] text-right"><p className="text-sm text-blue-800">"Je suis dessus, je vous envoie ça vite..."</p></div><div className="text-center mt-4"><span className="px-3 py-1 bg-red-50 text-red-600 text-xs font-bold rounded-full">Pression inutile</span></div></div></Reveal>
            <Reveal delay={200}><h2 className="text-3xl font-bold text-gray-900 mb-6">Le "Silence Radio" <br/> tue la confiance.</h2><p className="text-gray-500 mb-8">Entre le devis et la livraison, c'est le flou. Vos clients s'inquiètent et vous relancent.</p><div className="space-y-4"><div className="flex gap-4"><div className="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center"><Clock size={20}/></div><div><h4 className="font-bold text-gray-900">Temps perdu</h4><p className="text-sm text-gray-500">Chaque email vous sort de votre flow.</p></div></div></div></Reveal>
          </div>
        </section>
      );

      const Solution = () => (
        <section id="concept" className="py-24 bg-white border-b border-gray-100 overflow-hidden">
          <div className="container mx-auto px-6 max-w-6xl flex flex-col lg:flex-row items-center gap-20">
            <div className="lg:w-1/2">
                <Reveal><div className="inline-block px-3 py-1 bg-blue-50 text-blue-600 text-xs font-bold rounded-full mb-6">La solution Peekit</div><h2 className="text-4xl font-bold text-gray-900 mb-6">Transformez l'attente en excitation.</h2><p className="text-gray-500 text-lg mb-10">Ne dites plus "ça avance". Montrez-le. Peekit génère un lien de suivi unique.</p></Reveal>
                <div className="space-y-8">{[{icon: Smartphone, title:"Visibilité Totale", text:"Lien unique sécurisé."}, {icon: Zap, title:"Effet Dopamine", text:"Chaque étape validée notifie le client."}, {icon: Activity, title:"Teasing", text:"Partagez des aperçus pour maintenir l'excitation."}].map((i,idx)=><Reveal key={idx} delay={idx*100}><div className="flex gap-5"><div className="w-12 h-12 bg-gray-50 rounded-xl flex items-center justify-center shrink-0"><i.icon size={20}/></div><div><h3 className="font-bold text-gray-900">{i.title}</h3><p className="text-sm text-gray-500">{i.text}</p></div></div></Reveal>)}</div>
            </div>
            <div className="lg:w-1/2 flex justify-center"><Reveal delay={300}><div className="hover:rotate-3 transition-transform duration-700"><DemoPhone/></div></Reveal></div>
          </div>
        </section>
      );

      const Benefits = () => (
        <section className="py-24 bg-gray-50 border-b border-gray-200">
          <div className="container mx-auto px-6 max-w-6xl">
            <Reveal><div className="text-center mb-16"><h2 className="text-3xl font-bold text-gray-900 mb-4">Pourquoi passer sur Peekit ?</h2><p className="text-gray-500">Un outil de vente, pas juste d'organisation.</p></div></Reveal>
            <div className="grid md:grid-cols-3 gap-6">{[{icon:<ShieldCheck/>, title:"Tranquillité", desc:"Fini le harcèlement SMS."}, {icon:<Diamond/>, title:"Valeur Perçue", desc:"Justifiez des tarifs plus élevés."}, {icon:<Sparkles/>, title:"Fidélisation", desc:"Une livraison mémorable."}].map((b,i)=><Reveal key={i} delay={i*100} className="h-full"><div className="p-8 bg-white border border-gray-200 rounded-2xl h-full"><div className="w-12 h-12 bg-gray-50 rounded-lg flex items-center justify-center mb-6">{React.cloneElement(b.icon,{size:24})}</div><h3 className="font-bold text-lg mb-3">{b.title}</h3><p className="text-sm text-gray-500">{b.desc}</p></div></Reveal>)}</div>
          </div>
        </section>
      );

      const ProductShowcase = () => {
        const projects = [
          { id: 1, client: "Nike Air Max Launch", type: "VIDÉO PUBLICITAIRE", image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&q=80&w=800", update: "À l'instant", progress: 60, completed: false },
          { id: 2, client: "Sophie & Thomas", type: "MARIAGE", image: "https://images.unsplash.com/photo-1519741497674-611481863552?auto=format&fit=crop&q=80&w=800", update: "Il y a 2h", progress: 100, completed: true },
          { id: 3, client: "Bloom Coffee", type: "IDENTITÉ VISUELLE", image: "https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&q=80&w=800", update: "Il y a 5h", progress: 20, completed: false },
          { id: 4, client: "Paris Fashion Week", type: "SHOOTING MODE", image: "https://images.unsplash.com/photo-1469334031218-e382a71b716b?auto=format&fit=crop&q=80&w=800", update: "Hier", progress: 40, completed: false },
          { id: 5, client: "Tesla Model Y", type: "VIDÉO", image: "https://images.unsplash.com/photo-1617788138017-80ad40651399?auto=format&fit=crop&q=80&w=800", update: "Il y a 1j", progress: 80, completed: false },
          { id: 6, client: "Restaurant ONA", type: "CULINAIRE", image: "https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?auto=format&fit=crop&q=80&w=800", update: "Il y a 2j", progress: 100, completed: true }
        ];

        return (
          <section className="py-16 md:py-24 bg-white border-b border-gray-100 overflow-hidden">
            <div className="container mx-auto px-4 sm:px-6 max-w-7xl">
              <Reveal delay={200}>
                  <div className="relative mx-auto max-w-6xl">
                      <div className="bg-white rounded-xl border border-gray-200 shadow-[0_20px_40px_-10px_rgba(0,0,0,0.12)] overflow-hidden flex flex-col md:flex-row h-[400px] sm:h-[550px] md:h-[700px] text-left">
                          <div className="hidden md:flex w-60 border-r border-gray-100 bg-white flex-col shrink-0">
                              <div className="p-6 flex items-center gap-3 mb-2">
                                  <div className="w-8 h-8 bg-gray-900 rounded-xl flex items-center justify-center text-white shrink-0 shadow-sm"><Activity size={16} strokeWidth={1.5}/></div>
                                  <div className="flex flex-col"><span className="font-bold text-sm tracking-tight text-gray-900 leading-tight uppercase">STUDIO LUMIÈRE</span><span className="text-[9px] font-bold uppercase tracking-wider mt-1 px-1.5 py-0.5 rounded w-fit bg-indigo-50 text-indigo-600">Plan Pro</span></div>
                              </div>
                              <div className="flex-1 px-3 space-y-0.5">
                                  <div className="w-full flex items-center gap-3 px-3 py-2 rounded-lg bg-gray-50 text-gray-900 font-semibold cursor-default"><LayoutGrid size={16} strokeWidth={1.5} /> <span className="text-[13px]">Projets actifs</span></div>
                              </div>
                          </div>
                          <div className="flex-1 flex flex-col bg-white min-w-0">
                              <div className="h-14 md:h-16 border-b border-gray-100 flex items-center justify-between px-4 md:px-8 bg-white/80 shrink-0 sticky top-0 z-10 backdrop-blur-md">
                                  <div className="flex items-center gap-4"><h1 className="text-xs md:text-sm font-semibold text-gray-900">Dashboard</h1></div>
                                  <div className="flex items-center gap-4 md:gap-6">
                                      <div className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 text-xs font-bold border border-gray-200 uppercase tracking-widest cursor-default">SL</div>
                                  </div>
                              </div>
                              <div className="flex-1 overflow-hidden p-4 md:p-8 bg-white relative">
                                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5 pb-20">
                                      {projects.map((project) => (
                                          <div key={project.id} className="group bg-white rounded-xl border border-gray-100 p-4 md:p-5 hover:shadow-[0_8px_24px_rgba(0,0,0,0.04)] hover:border-gray-200 transition-all cursor-default relative">
                                              <div className="flex items-start justify-between mb-4 md:mb-6">
                                                  <div className="flex items-center gap-3 md:gap-4">
                                                      <img src={project.image} className="w-8 h-8 md:w-10 md:h-10 rounded-full object-cover border border-gray-100 shadow-sm" alt={project.client}/>
                                                      <div><h3 className="font-bold text-gray-900 text-xs md:text-sm group-hover:text-indigo-600 transition-colors tracking-tight line-clamp-1">{project.client}</h3><p className="text-[9px] md:text-[10px] font-bold text-gray-400 uppercase tracking-wider mt-0.5">{project.type}</p></div>
                                                  </div>
                                                  <div className={`px-2 py-1 rounded-md text-[9px] md:text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5 border ${project.completed ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-gray-50 text-gray-600 border-gray-100'}`}>
                                                      {project.completed ? <><Check size={10} strokeWidth={2} /> Terminé</> : <><Activity size={10} strokeWidth={2} /> En cours</>}
                                                  </div>
                                              </div>
                                              <div className="space-y-2">
                                                  <div className="h-1 w-full bg-gray-50 rounded-full overflow-hidden"><div className={`h-full rounded-full ${project.completed ? 'bg-emerald-500' : 'bg-gray-900'}`} style={{ width: `${project.progress}%` }}></div></div>
                                              </div>
                                          </div>
                                      ))}
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </Reveal>
            </div>
          </section>
        );
      };

      const Pricing = ({ onSelectPlan, onAuthClick }) => {
        const [isAnnual, setIsAnnual] = useState(true);
        const tiers = [
            { name:"Freelance", price:{monthly:9, annual:7.5}, features:["5 Projets", "Timeline standard"], icon:<Zap/> },
            { name:"Pro", highlight:true, price:{monthly:19, annual:15.8}, features:["Illimité", "Timeline perso", "Vidéo Teasers"], icon:<Sparkles/> },
            { name:"Agency", comingSoon:true, price:{monthly:49, annual:40.8}, features:["Multi-comptes", "API"], icon:<Building2/> }
        ];
        return (
            <section id="pricing" className="py-24 bg-gray-50">
                <div className="container mx-auto px-6 max-w-6xl">
                    <div className="text-center mb-16"><h2 className="text-4xl font-bold mb-4">Tarification simple</h2><div className="inline-flex bg-white border border-gray-200 p-1 rounded-xl"><button onClick={()=>setIsAnnual(false)} className={`px-4 py-2 rounded-lg text-sm font-medium ${!isAnnual?'bg-gray-100':''}`}>Mensuel</button><button onClick={()=>setIsAnnual(true)} className={`px-4 py-2 rounded-lg text-sm font-medium ${isAnnual?'bg-gray-900 text-white':''}`}>Annuel</button></div></div>
                    <div className="grid md:grid-cols-3 gap-6">{tiers.map((tier,i)=><div key={i} className={`p-8 rounded-2xl border bg-white flex flex-col ${tier.highlight?'shadow-xl border-gray-300 ring-1 ring-black/5':''} ${tier.comingSoon?'opacity-70':''}`}><div className="mb-6"><div className="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center mb-4">{tier.icon}</div><h3 className="font-bold text-lg">{tier.name}</h3></div><div className="mb-6"><span className="text-4xl font-bold">{isAnnual?Math.round(tier.price.annual):tier.price.monthly}€</span><span className="text-gray-400">/mois</span></div><ul className="space-y-3 mb-8 flex-1">{tier.features.map((f,j)=><li key={j} className="flex gap-2 text-sm"><Check size={16}/>{f}</li>)}</ul><Button variant={tier.highlight?'primary':'outline'} fullWidth onClick={()=>!tier.comingSoon && onSelectPlan({...tier, price: isAnnual?Math.round(tier.price.annual*12):tier.price.monthly, interval: isAnnual?'annual':'monthly'})} disabled={tier.comingSoon}>{tier.comingSoon?'Bientôt':'Choisir'}</Button></div>)}</div>
                </div>
            </section>
        );
      };

      const Footer = ({ onAuthClick }) => (
        <footer className="bg-white border-t border-gray-200 py-16">
          <div className="container mx-auto px-6 max-w-6xl">
            <div className="flex flex-col md:flex-row justify-between items-center gap-8">
                <div className="flex items-center gap-2"><div className="bg-gray-900 text-white p-1.5 rounded-lg"><Activity size={18} strokeWidth={2.5} /></div><span className="font-bold text-lg tracking-tight text-gray-900">Peekit</span></div>
                <div className="text-sm text-gray-500">&copy; {new Date().getFullYear()} Peekit. Fait avec passion à Paris.</div>
                <div className="flex gap-6"><a href="#" className="text-gray-400 hover:text-gray-900 transition-colors"><Instagram size={20}/></a><a href="#" className="text-gray-400 hover:text-gray-900 transition-colors"><Twitter size={20}/></a><a href="#" className="text-gray-400 hover:text-gray-900 transition-colors"><Linkedin size={20}/></a></div>
            </div>
          </div>
        </footer>
      );

      // --- AUTH PAGE ---

      const AuthPage = ({ onBack, onLogin, initialView }) => {
        const [isLogin, setIsLogin] = useState(initialView === 'login');
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState(null);
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
            e.preventDefault();
            setLoading(true); setError(null);
            try {
                const { error } = isLogin 
                    ? await supabase.auth.signInWithPassword({ email, password })
                    : await supabase.auth.signUp({ email, password });
                if (error) throw error;
            } catch (err) { setError(err.message); } finally { setLoading(false); }
        };

        return (
            <div className="min-h-screen flex bg-white font-sans">
                <div className="hidden lg:flex w-1/2 bg-dot-pattern items-center justify-center p-12 border-r border-gray-200"><div className="max-w-md space-y-8"><div className="inline-flex items-center gap-2 px-3 py-1 bg-white ring-1 ring-gray-200 text-xs font-bold rounded-md">Version 2.0</div><h2 className="text-4xl font-bold tracking-tighter">L'OS des studios créatifs.</h2></div></div>
                <div className="w-full lg:w-1/2 flex flex-col justify-center items-center p-8 relative">
                    <button onClick={onBack} className="absolute top-8 left-8 flex items-center gap-2 text-xs font-bold uppercase"><ArrowLeft size={14}/> Retour</button>
                    <div className="w-full max-w-sm space-y-8">
                        <div className="text-center"><div className="w-10 h-10 bg-black text-white rounded-lg flex items-center justify-center mx-auto mb-6"><Activity/></div><h1 className="text-2xl font-bold">{isLogin?'Bon retour':'Créer un compte'}</h1></div>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded text-xs">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="text-[10px] font-bold uppercase text-gray-500">Email</label><input type="email" required value={email} onChange={e=>setEmail(e.target.value)} className="w-full px-3 py-2 border rounded-md text-sm outline-none focus:border-black"/></div>
                            <div><label className="text-[10px] font-bold uppercase text-gray-500">Mot de passe</label><input type="password" required value={password} onChange={e=>setPassword(e.target.value)} className="w-full px-3 py-2 border rounded-md text-sm outline-none focus:border-black"/></div>
                            <Button variant="black" fullWidth type="submit" isLoading={loading}>{isLogin?'Se connecter':"S'inscrire"}</Button>
                        </form>
                        <div className="text-center text-sm"><button onClick={()=>setIsLogin(!isLogin)} className="font-bold hover:underline">{isLogin?"S'inscrire":"Connexion"}</button></div>
                    </div>
                </div>
            </div>
        );
      };

      // --- ONBOARDING ---

      const OnboardingWizard = ({ onComplete }) => {
        const [step, setStep] = useState(1);
        const [studioName, setStudioName] = useState('');
        const [clientName, setClientName] = useState('');
        const [clientEmail, setClientEmail] = useState('');
        const [projectDate, setProjectDate] = useState('');
        const [projectLocation, setProjectLocation] = useState('');
        const [projectType, setProjectType] = useState('Mariage');
        const [isLoading, setIsLoading] = useState(false);

        const handleNext = () => { if (step === 1 && studioName) setStep(2); if (step === 2 && clientName && clientEmail && projectDate) setStep(3); };
        const handleFinish = () => {
            setIsLoading(true);
            let formattedDate = projectDate;
            if (projectDate) { const [y, m, d] = projectDate.split('-').map(Number); formattedDate = new Date(y, m-1, d).toLocaleDateString('fr-FR', { day:'numeric', month:'long', year:'numeric' }); }
            const firstProject = { id: Date.now().toString(), clientName, clientEmail, date: formattedDate, location: projectLocation||'Non spécifié', type: projectType, coverImage: 'https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&q=80&w=800', currentStage: 'secured', lastUpdate: "À l'instant", teasers: [] };
            setTimeout(() => onComplete(studioName, firstProject), 1500);
        };

        return (
            <div className="min-h-screen bg-dot-pattern flex flex-col items-center justify-center p-6 font-sans">
              <div className="w-full max-w-md mb-8 flex justify-center gap-2"><div className={`h-1.5 w-12 rounded-full ${step >= 1 ? 'bg-black' : 'bg-gray-200'}`}></div><div className={`h-1.5 w-12 rounded-full ${step >= 2 ? 'bg-black' : 'bg-gray-200'}`}></div><div className={`h-1.5 w-12 rounded-full ${step >= 3 ? 'bg-black' : 'bg-gray-200'}`}></div></div>
              <div className="w-full max-w-md bg-white border border-gray-200 shadow-sm rounded-xl p-8 relative">
                {step === 1 && <div className="animate-fade-in"><h2 className="text-2xl font-bold mb-2">Studio</h2><input autoFocus value={studioName} onChange={e => setStudioName(e.target.value)} placeholder="Nom du Studio" className="w-full px-4 py-3 border rounded-md mb-4"/><Button variant="black" fullWidth onClick={handleNext} disabled={!studioName}>Continuer</Button></div>}
                {step === 2 && <div className="animate-fade-in"><h2 className="text-2xl font-bold mb-2">Premier Projet</h2><div className="space-y-4"><input autoFocus value={clientName} onChange={e => setClientName(e.target.value)} placeholder="Client" className="w-full px-3 py-2 border rounded-md"/><input value={clientEmail} onChange={e => setClientEmail(e.target.value)} placeholder="Email" className="w-full px-3 py-2 border rounded-md"/><input type="date" value={projectDate} onChange={e => setProjectDate(e.target.value)} className="w-full px-3 py-2 border rounded-md"/><Button variant="black" fullWidth onClick={handleNext} disabled={!clientName}>Créer</Button></div></div>}
                {step === 3 && <div className="animate-fade-in text-center"><h2 className="text-2xl font-bold mb-2">Prêt.</h2><Button variant="black" fullWidth onClick={handleFinish} isLoading={isLoading}>Accéder</Button></div>}
              </div>
            </div>
        );
      };

      // --- CHECKOUT ---

      const CheckoutPage = ({ plan, onBack, onSuccess }) => {
        const [isLoading, setIsLoading] = useState(false);
        const handleSubmit = (e) => { e.preventDefault(); setIsLoading(true); setTimeout(() => { setIsLoading(false); onSuccess(); }, 2000); };
        return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center p-6"><div className="w-full max-w-md bg-white p-8 rounded-xl border border-gray-200 shadow-sm"><button onClick={onBack} className="mb-6 flex items-center gap-2 text-xs font-bold uppercase"><ArrowLeft size={14}/> Retour</button><h2 className="text-xl font-bold mb-6">Paiement {plan.price}€</h2><form onSubmit={handleSubmit}><input required className="w-full mb-4 p-3 border rounded-md" placeholder="Carte Bancaire"/><Button fullWidth variant="black" isLoading={isLoading} type="submit">Payer</Button></form></div></div>
        );
      };

      // --- CLIENT ACCESS ---

      const ClientAccessGate = ({ project, onAccessGranted }) => {
        const [password, setPassword] = useState('');
        const [error, setError] = useState(false);
        const [isLoading, setIsLoading] = useState(false);
        const handleSubmit = (e) => { e.preventDefault(); setIsLoading(true); setTimeout(() => { if (password === project.accessPassword) onAccessGranted(); else { setError(true); setIsLoading(false); } }, 800); };
        return (
            <div className="min-h-screen bg-dot-pattern flex items-center justify-center p-6"><div className="w-full max-w-sm bg-white p-8 rounded-xl border border-gray-200 text-center shadow-sm"><Lock size={24} className="mx-auto mb-4"/><h1 className="text-lg font-bold mb-6">Espace Sécurisé</h1><form onSubmit={handleSubmit}><input type="password" value={password} onChange={e=>{setPassword(e.target.value);setError(false)}} placeholder="Mot de passe" className="w-full p-3 border rounded-md mb-4 text-center"/><Button fullWidth variant="black" isLoading={isLoading} type="submit">Accéder</Button></form></div></div>
        );
      };

      // --- DASHBOARD & PROJECT DETAILS ---

      const Dashboard = ({ studioName, onLogout, onOpenProject, projects, stageConfig, onCreateProject, onDeleteProject, onEditProject, onUpgradeClick }) => {
        const [isNewOpen, setIsNewOpen] = useState(false);
        const [newProj, setNewProj] = useState({ clientName: '', clientEmail: '', date: '', location: '', type: 'Mariage' });
        const [coverFile, setCoverFile] = useState(undefined);
        
        return (
            <div className="flex h-screen bg-[#F3F4F6]">
                <aside className="w-64 bg-white border-r border-gray-200 flex flex-col p-6 hidden md:flex">
                    <div className="flex items-center gap-2 mb-10"><div className="w-8 h-8 bg-gray-900 rounded-lg flex items-center justify-center text-white"><Activity size={16}/></div><span className="font-bold text-xl">Peekit</span></div>
                    <nav className="flex-1 space-y-1"><button className="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg bg-gray-100 text-gray-900 text-sm font-medium"><LayoutGrid size={18}/> Projets</button></nav>
                    <button onClick={onLogout} className="flex items-center gap-3 px-4 py-2 text-sm text-gray-400 hover:text-red-600"><LogOut size={18}/> Déconnexion</button>
                </aside>
                <main className="flex-1 flex flex-col overflow-hidden">
                    <header className="h-16 border-b border-gray-200 bg-[#F3F4F6] flex items-center justify-between px-8"><h1 className="text-2xl font-bold">Mes Projets</h1><div className="w-8 h-8 bg-white rounded-full flex items-center justify-center font-bold border border-gray-200">{studioName.substring(0,2)}</div></header>
                    <div className="flex-1 p-8 overflow-y-auto">
                        <div className="bg-white rounded-xl border border-gray-200 p-6 h-full flex flex-col">
                            <div className="flex justify-between mb-6">
                                <div className="relative"><Search size={16} className="absolute left-3 top-2.5 text-gray-400"/><input placeholder="Rechercher..." className="pl-9 pr-4 py-2 border rounded-lg text-sm w-64"/></div>
                                <button onClick={()=>setIsNewOpen(true)} className="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><Plus size={16}/> Nouveau</button>
                            </div>
                            <div className="flex-1 overflow-auto"><table className="w-full text-sm text-left"><thead className="text-xs text-gray-400 uppercase border-b"><tr className="h-10"><th>Projet</th><th>Client</th><th>Statut</th><th></th></tr></thead><tbody>{projects.map(p=><tr key={p.id} onClick={()=>onOpenProject(p)} className="h-16 border-b cursor-pointer hover:bg-gray-50"><td><div className="flex items-center gap-3"><img src={p.coverImage} className="w-8 h-8 rounded object-cover"/><span className="font-bold">{p.type}</span></div></td><td>{p.clientName}</td><td><span className="bg-gray-100 px-2 py-1 rounded text-xs font-bold">En cours</span></td><td><button onClick={(e)=>{e.stopPropagation();onDeleteProject(p.id)}} className="p-2 hover:bg-red-50 text-red-500 rounded"><Trash2 size={14}/></button></td></tr>)}</tbody></table></div>
                        </div>
                    </div>
                </main>
                {isNewOpen && (
                    <div className="fixed inset-0 bg-black/20 flex items-center justify-center p-4 backdrop-blur-sm z-50">
                        <div className="bg-white p-8 rounded-2xl w-full max-w-md shadow-xl animate-slide-up">
                            <h2 className="text-xl font-bold mb-6">Nouveau Projet</h2>
                            <div className="space-y-4">
                                <input autoFocus placeholder="Client" className="w-full p-3 border rounded-lg" value={newProj.clientName} onChange={e=>setNewProj({...newProj, clientName: e.target.value})}/>
                                <input type="date" className="w-full p-3 border rounded-lg" value={newProj.date} onChange={e=>setNewProj({...newProj, date: e.target.value})}/>
                                <input type="file" onChange={e=>e.target.files && setCoverFile(e.target.files[0])} className="w-full text-xs"/>
                            </div>
                            <div className="flex gap-2 mt-6"><Button fullWidth variant="outline" onClick={()=>setIsNewOpen(false)}>Annuler</Button><Button fullWidth variant="black" onClick={()=>{onCreateProject(newProj, coverFile); setIsNewOpen(false);}}>Créer</Button></div>
                        </div>
                    </div>
                )}
            </div>
        );
      };

      const ProjectDetails = ({ project, onBack, onUpdateStage, stageConfig, onUpdateStageConfig, defaultConfig, onViewClientVersion, onUpdatePassword, onUploadTeasers, onDeleteTeaser, onUpdateCoverImage }) => {
          const [isEditingWorkflow, setIsEditingWorkflow] = useState(false);
          const [localWorkflow, setLocalWorkflow] = useState(stageConfig ? stageConfig.map(s => ({ ...s })) : []);
          const [password, setPassword] = useState(project.accessPassword || '');
          const fileInputRef = useRef(null);
          const coverInputRef = useRef(null);

          useEffect(() => { if (stageConfig) setLocalWorkflow(stageConfig.map(s => ({ ...s }))); }, [stageConfig]);

          const currentStageIndex = stageConfig.findIndex(s => s.id === project.currentStage);
          const getProgress = () => stageConfig.length === 0 ? 0 : Math.round(((currentStageIndex + 1) / stageConfig.length) * 100);

          const handleResetToDefault = async () => {
              if (confirm("Reset workflow ?")) {
                  const freshConfig = defaultConfig.map(s => ({ ...s }));
                  setLocalWorkflow(freshConfig); 
                  await onUpdateStageConfig(freshConfig); 
                  setIsEditingWorkflow(false); 
              }
          };

          return (
              <div className="min-h-screen bg-[#F3F4F6] p-4 md:p-8 font-sans">
                  <header className="flex items-center justify-between mb-8">
                      <div className="flex items-center gap-4"><button onClick={onBack} className="w-10 h-10 bg-white border rounded-lg flex items-center justify-center hover:bg-gray-50"><ArrowLeft size={20}/></button><h1 className="text-2xl font-bold">{project.clientName}</h1></div>
                      <Button onClick={onViewClientVersion} variant="outline" size="sm">Vue Client <ExternalLink size={14} className="ml-2"/></Button>
                  </header>
                  <div className="grid lg:grid-cols-3 gap-8">
                      <div className="lg:col-span-2 bg-white rounded-xl border border-gray-200 p-8">
                          <div className="flex justify-between items-center mb-6">
                              <h3 className="font-bold">Avancement</h3>
                              <div className="flex gap-2">
                                  {isEditingWorkflow ? (
                                      <><button onClick={handleResetToDefault} className="text-xs text-red-600 font-bold px-2">Reset</button><Button size="sm" variant="black" onClick={async () => { await onUpdateStageConfig(localWorkflow); setIsEditingWorkflow(false); }}>Sauvegarder</Button></>
                                  ) : (
                                      <button onClick={() => setIsEditingWorkflow(true)} className="p-2 text-gray-400 hover:bg-gray-100 rounded"><Pencil size={14}/></button>
                                  )}
                              </div>
                          </div>
                          <div className="space-y-6 pl-4 border-l border-gray-100">
                              {(isEditingWorkflow ? localWorkflow : stageConfig).map((step, i) => {
                                  const isCurrent = step.id === project.currentStage;
                                  return (
                                      <div key={i} onClick={()=>!isEditingWorkflow && onUpdateStage(step.id)} className={`relative pl-6 ${!isEditingWorkflow ? 'cursor-pointer group' : ''} ${isCurrent?'opacity-100':'opacity-60 hover:opacity-100'}`}>
                                          <div className={`absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full ${isCurrent?'bg-indigo-600 ring-4 ring-indigo-50':'bg-gray-200'}`}></div>
                                          {isEditingWorkflow ? (
                                              <input value={step.label} onChange={e => { const n = [...localWorkflow]; n[i].label = e.target.value; setLocalWorkflow(n); }} className="border rounded px-2 py-1 text-sm font-bold w-full"/>
                                          ) : (
                                              <><h4 className={`font-bold ${isCurrent?'text-indigo-900':'text-gray-900'}`}>{step.label}</h4><p className="text-xs text-gray-500">{step.message}</p></>
                                          )}
                                      </div>
                                  )
                              })}
                          </div>
                      </div>
                      <div className="space-y-6">
                          <div className="bg-white rounded-xl border border-gray-200 p-6">
                              <h3 className="font-bold text-sm mb-4">Accès Client</h3>
                              <div className="bg-gray-50 p-3 rounded text-xs font-mono break-all mb-4">{window.location.origin}/#/v/{project.id}</div>
                              <label className="text-[10px] font-bold uppercase text-gray-400">Mot de passe</label>
                              <div className="flex gap-2"><input type="text" value={password} onChange={e=>setPassword(e.target.value)} className="w-full border rounded px-2 py-1 font-bold text-center"/><button onClick={()=>onUpdatePassword(password)} className="bg-black text-white p-1 rounded"><Check size={14}/></button></div>
                          </div>
                          <div className="bg-white rounded-xl border border-gray-200 p-6">
                              <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-sm">Fichiers</h3><button onClick={()=>fileInputRef.current.click()}><Plus size={16}/></button></div>
                              <input type="file" ref={fileInputRef} className="hidden" multiple onChange={e=>e.target.files && onUploadTeasers(Array.from(e.target.files))}/>
                              <div className="grid grid-cols-2 gap-2">
                                  {project.teasers?.map(t=><div key={t.id} className="aspect-square bg-gray-100 rounded relative group"><img src={t.url} className="w-full h-full object-cover rounded"/><button onClick={()=>onDeleteTeaser(t.id)} className="absolute top-1 right-1 bg-white text-red-500 p-1 rounded opacity-0 group-hover:opacity-100"><Trash2 size={12}/></button></div>)}
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          )
      };

      const ClientTrackingPage = ({ project, stageConfig }) => {
          const currentIdx = stageConfig.findIndex(s => s.id === project.currentStage);
          const progress = Math.round(((currentIdx + 1) / stageConfig.length) * 100);
          return (
              <div className="min-h-screen bg-[#F3F4F6] pb-20 font-sans">
                  <header className="bg-white h-16 px-6 flex items-center justify-between border-b"><div className="font-bold flex items-center gap-2"><Activity size={16}/> Peekit</div><span className="px-3 py-1 bg-emerald-50 text-emerald-700 text-xs font-bold rounded-full">Espace Client</span></header>
                  <div className="max-w-4xl mx-auto p-6 space-y-6">
                      <div className="bg-gray-900 text-white p-8 rounded-2xl shadow-xl">
                          <div className="text-xs font-bold opacity-60 uppercase mb-2">Projet</div>
                          <h1 className="text-3xl font-bold mb-6">{project.clientName}</h1>
                          <div className="flex gap-8"><div className="text-center"><div className="text-2xl font-bold">{progress}%</div><div className="text-xs opacity-60">Avancement</div></div></div>
                      </div>
                      <div className="bg-white p-8 rounded-2xl border border-gray-200">
                          <h3 className="font-bold mb-6">Timeline</h3>
                          <div className="space-y-8 pl-4 border-l border-gray-100">
                              {stageConfig.map((s,i) => (
                                  <div key={s.id} className={`relative pl-6 ${i<=currentIdx ? 'opacity-100':'opacity-40'}`}>
                                      <div className={`absolute -left-[5px] top-1 w-2.5 h-2.5 rounded-full ${i<=currentIdx ? 'bg-emerald-500':'bg-gray-200'}`}></div>
                                      <h4 className="font-bold">{s.label}</h4>
                                      <p className="text-sm text-gray-500">{s.message}</p>
                                  </div>
                              ))}
                          </div>
                      </div>
                  </div>
              </div>
          )
      };

      // --- APP ROOT ---

      function App() {
        const [currentPage, setCurrentPage] = useState('loading');
        const [session, setSession] = useState(null);
        const [projects, setProjects] = useState([]);
        const [userPlan, setUserPlan] = useState('freelance');
        const [stageConfig, setStageConfig] = useState(INITIAL_STAGES_CONFIG);
        const [editingProject, setEditingProject] = useState(null);
        const [clientViewProject, setClientViewProject] = useState(null);
        const [authMode, setAuthMode] = useState('login');
        const [isAccessGranted, setIsAccessGranted] = useState(false);
        const [studioName, setStudioName] = useState('Studio');

        useEffect(() => {
            const hash = window.location.hash;
            if (hash.startsWith('#/v/')) {
                const pid = hash.split('/v/')[1];
                if (pid) fetchPublicProject(pid);
                return;
            }
            supabase.auth.getSession().then(({data:{session}}) => initApp(session));
            supabase.auth.onAuthStateChange((_e, session) => {
                if (_e === 'SIGNED_OUT') setCurrentPage('home');
                else if (_e === 'SIGNED_IN') initApp(session);
            });
        }, []);

        const initApp = async (session) => {
            if (!session) { setCurrentPage('home'); return; }
            setSession(session);
            
            // 1. Fetch Projects
            const { data } = await supabase.from('projects').select('*, teasers(*)').eq('user_id', session.user.id);
            const mapped = (data||[]).map(p => ({
                id: p.id, clientName: p.client_name, type: p.type || 'Autre', 
                currentStage: p.current_stage || 'secured', coverImage: p.cover_image,
                date: p.date, location: p.location, accessPassword: p.access_password,
                teasers: p.teasers ? p.teasers.map(t => ({id: t.id, url: t.url, type: t.type, title: t.title})) : []
            }));
            setProjects(mapped);
            
            // 2. Fetch Profile
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
            if (profile) {
                if (profile.stages_config?.length) setStageConfig(profile.stages_config);
                if (profile.studio_name) setStudioName(profile.studio_name);
                setUserPlan(profile.plan || 'freelance');
                if (profile.onboarding_completed) setCurrentPage('dashboard');
                else setCurrentPage('onboarding');
            } else {
                setCurrentPage('dashboard');
            }
        };

        const fetchPublicProject = async (id) => {
            const { data } = await supabase.from('projects').select('*, teasers(*)').eq('id', id).single();
            if (data) {
                const { data: prof } = await supabase.from('profiles').select('stages_config').eq('id', data.user_id).single();
                if (prof?.stages_config) setStageConfig(prof.stages_config);
                const mapped = {
                    ...data, clientName: data.client_name, currentStage: data.current_stage, accessPassword: data.access_password,
                    teasers: data.teasers ? data.teasers.map(t => ({id: t.id, url: t.url, type: t.type, title: t.title})) : []
                };
                setClientViewProject(mapped);
                setCurrentPage('client-view');
            } else {
                setCurrentPage('home');
            }
        };

        const handleCreate = async (proj, coverFile) => {
            if (!session) return;
            let coverUrl = 'https://images.unsplash.com/photo-1497935586351-b67a49e012bf?auto=format&fit=crop&q=80&w=800';
            if (coverFile) { coverUrl = await compressImage(coverFile); }
            
            const newP = { 
                user_id: session.user.id, client_name: proj.clientName, type: proj.type, 
                current_stage: stageConfig[0].id, created_at: new Date().toISOString(),
                cover_image: coverUrl, date: proj.date, location: proj.location
            };
            const { data } = await supabase.from('projects').insert([newP]).select().single();
            if (data) {
                const mapped = { id: data.id, clientName: data.client_name, type: data.type, currentStage: data.current_stage, coverImage: data.cover_image, date: data.date, location: data.location, teasers: [] };
                setProjects([mapped, ...projects]);
            }
        };

        const handleUpdateStage = async (stageId) => {
            if (!editingProject) return;
            await supabase.from('projects').update({ current_stage: stageId }).eq('id', editingProject.id);
            const updated = { ...editingProject, currentStage: stageId };
            setEditingProject(updated);
            setProjects(projects.map(p => p.id => p.id === updated.id ? updated : p));
        };

        const handleUpdateStageConfig = async (newConfig) => {
            setStageConfig(newConfig);
            if (session) await supabase.from('profiles').update({ stages_config: newConfig }).eq('id', session.user.id);
        };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 1024 / img.width;
                        canvas.width = 1024;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    }
                }
            })
        };

        const handleUploadTeasers = async (files) => {
            if (!editingProject) return;
            const newTeasers = [];
            for (const f of files) {
                const base64 = await compressImage(f);
                const { data } = await supabase.from('teasers').insert([{ project_id: editingProject.id, type: 'image', url: base64, user_id: session.user.id }]).select().single();
                if (data) newTeasers.push({ id: data.id, url: data.url, type: 'image', title: 'Media' });
            }
            const updated = { ...editingProject, teasers: [...(editingProject.teasers||[]), ...newTeasers] };
            setEditingProject(updated);
            setProjects(projects.map(p => p.id === updated.id ? updated : p));
        };

        const handleDeleteTeaser = async (tid) => {
            await supabase.from('teasers').delete().eq('id', tid);
            const updated = { ...editingProject, teasers: editingProject.teasers.filter(t => t.id !== tid) };
            setEditingProject(updated);
            setProjects(projects.map(p => p.id === updated.id ? updated : p));
        };

        const onUpdatePassword = async (pwd) => {
            await supabase.from('projects').update({ access_password: pwd }).eq('id', editingProject.id);
            setEditingProject({ ...editingProject, accessPassword: pwd });
        };

        const onDeleteProject = async (pid) => {
            await supabase.from('teasers').delete().eq('project_id', pid);
            await supabase.from('projects').delete().eq('id', pid);
            setProjects(projects.filter(p => p.id !== pid));
        };

        const onEditProject = async (pid, data, file) => {
            let updates = { client_name: data.clientName, type: data.type, date: data.date, location: data.location };
            if (file) updates.cover_image = await compressImage(file);
            await supabase.from('projects').update(updates).eq('id', pid);
            const { data: fresh } = await supabase.from('projects').select('*, teasers(*)').eq('id', pid).single();
            const mapped = {
                id: fresh.id, clientName: fresh.client_name, type: fresh.type, 
                currentStage: fresh.current_stage, coverImage: fresh.cover_image,
                date: fresh.date, location: fresh.location, accessPassword: fresh.access_password,
                teasers: fresh.teasers ? fresh.teasers.map(t => ({id: t.id, url: t.url, type: t.type, title: t.title})) : []
            };
            setProjects(projects.map(p => p.id === pid ? mapped : p));
        };

        const handleAuthNavigation = (mode) => {
            setAuthMode(mode);
            setCurrentPage('auth');
        };

        if (currentPage === 'loading') return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin"/></div>;
        if (currentPage === 'auth') return <AuthPage onBack={()=>setCurrentPage('home')} onLogin={()=>{}} initialView={authMode}/>;
        if (currentPage === 'onboarding') return <OnboardingWizard onComplete={(name, proj) => { setStudioName(name); handleCreate(proj); setCurrentPage('dashboard'); }}/>;
        if (currentPage === 'dashboard') return <Dashboard studioName={studioName} userPlan={userPlan} onLogout={()=>supabase.auth.signOut()} projects={projects} onOpenProject={(p)=>{setEditingProject(p); setCurrentPage('project-details')}} onCreateProject={handleCreate} stageConfig={stageConfig} onDeleteProject={onDeleteProject} onEditProject={onEditProject} onUpgradeClick={()=>{}}/>;
        if (currentPage === 'project-details' && editingProject) return <ProjectDetails project={editingProject} stageConfig={stageConfig} defaultConfig={INITIAL_STAGES_CONFIG} userPlan={userPlan} onBack={()=>{setEditingProject(null); setCurrentPage('dashboard')}} onUpdateStage={handleUpdateStage} onUpdateStageConfig={handleUpdateStageConfig} onViewClientVersion={()=>{setClientViewProject(editingProject); setCurrentPage('client-view');}} onUpdatePassword={onUpdatePassword} onUploadTeasers={handleUploadTeasers} onDeleteTeaser={handleDeleteTeaser} onUpdateCoverImage={async (f) => { const url = await compressImage(f); await supabase.from('projects').update({cover_image: url}).eq('id', editingProject.id); setEditingProject({...editingProject, coverImage: url}); setProjects(projects.map(p=>p.id===editingProject.id?{...p, coverImage:url}:p)); }}/>;
        if (currentPage === 'client-view' && clientViewProject) {
            if (clientViewProject.accessPassword && !isAccessGranted) return <ClientAccessGate project={clientViewProject} onAccessGranted={()=>setIsAccessGranted(true)}/>;
            return <ClientTrackingPage project={clientViewProject} stageConfig={stageConfig} onBack={()=>{setIsAccessGranted(false); setClientViewProject(null); setCurrentPage('project-details');}}/>;
        }

        return (
            <div>
                <StickyHeader onAuthClick={handleAuthNavigation}/>
                <Hero onAuthClick={handleAuthNavigation}/>
                <Problem />
                <Solution />
                <Benefits />
                <ProductShowcase />
                <Pricing onSelectPlan={() => { setAuthMode('signup'); setCurrentPage('auth'); }} onAuthClick={handleAuthNavigation} />
                <Footer onAuthClick={handleAuthNavigation} />
            </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
